name: Build Android APK

on:
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      # 1. Prepare Web Assets (Smart Shell Mode)
      - name: Prepare Web Assets
        run: |
          mkdir -p www
          
          # --- 1. CREATE THE SMART LAUNCHER (Local index.html) ---
          # This file lives on the phone. It handles errors and redirects.
          cat <<EOF > www/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AERO Launcher</title>
              <style>
                  body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; height: 100vh; display: flex; justify-content: center; align-items: center; user-select: none; }
                  
                  /* --- LOADER SCREEN --- */
                  #loading-screen { text-align: center; transition: opacity 0.5s; }
                  .spinner { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
                  
                  /* --- ERROR SCREEN (Hidden by default) --- */
                  #error-screen { display: none; flex-direction: column; align-items: center; text-align: center; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 80%; animation: popup 0.3s ease-out; }
                  .error-icon { font-size: 50px; color: #e74c3c; margin-bottom: 15px; }
                  .retry-btn { background: #3498db; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
                  .retry-btn:active { transform: scale(0.95); }
                  
                  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                  @keyframes popup { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
              </style>
          </head>
          <body>
              
              <div id="loading-screen">
                  <div class="spinner"></div>
                  <h3 style="color:#555;">Connecting securely...</h3>
              </div>

              <div id="error-screen">
                  <div class="error-icon">⚠️</div>
                  <h2 style="margin:0; color:#333;">Connection Failed</h2>
                  <p style="color:#666; margin-top:10px;">We couldn't reach the server. Please check your internet.</p>
                  <button class="retry-btn" onclick="checkConnection()">Try Again</button>
              </div>

              <script>
                  // --- CONFIGURATION ---
                  const REMOTE_URL = "https://raw.githubusercontent.com/saikat-pundit/Data-Digitization-Android-App/refs/heads/main/index.html"; // <--- PUT YOUR URL HERE
                  
                  function checkConnection() {
                      // 1. Reset UI to Loading State
                      document.getElementById('error-screen').style.display = 'none';
                      document.getElementById('loading-screen').style.display = 'block';

                      // 2. Simple Network Check
                      // We try to fetch the site (HEAD request is fast). 
                      // 'no-cors' mode is required to allow checking remote domains without crashing.
                      fetch(REMOTE_URL, { method: 'HEAD', mode: 'no-cors' })
                      .then(() => {
                          // SUCCESS: Internet is good. Launch the app.
                          // 'location.replace' replaces the history so back button exits app, doesn't go back to loader.
                          window.location.replace(REMOTE_URL);
                      })
                      .catch(() => {
                          // FAILURE: Show Error Screen
                          showError();
                      });
                      
                      // Fallback: If fetch hangs forever (rare), show error after 10 seconds
                      setTimeout(() => {
                          if(document.getElementById('loading-screen').style.display !== 'none') showError();
                      }, 10000);
                  }

                  function showError() {
                      document.getElementById('loading-screen').style.display = 'none';
                      document.getElementById('error-screen').style.display = 'flex';
                  }

                  // Run immediately on open
                  window.onload = checkConnection;
              </script>
          </body>
          </html>
          EOF
          
          # Move images (Logo & Splash)
          if [ -f logo.png ]; then cp logo.png www/; fi
          if [ -f splash.png ]; then cp splash.png www/; fi
          
          # --- 2. CAPACITOR CONFIG (LOCAL MODE) ---
          # IMPORTANT: We DO NOT put 'server.url' here. 
          # We let the app load the local 'www/index.html' we just created above.
          # We enable 'allowNavigation' so the local file is allowed to redirect to your website.
          
          cat <<EOF > capacitor.config.json
          {
            "appId": "com.aero.app",
            "appName": "AERO",
            "webDir": "www",
            "server": {
              "allowNavigation": ["*"],
              "cleartext": true
            },
            "plugins": {
              "SplashScreen": {
                "launchShowDuration": 2000, 
                "launchAutoHide": true,
                "backgroundColor": "#f0f2f5",
                "androidSplashResourceName": "splash",
                "showSpinner": false,
                "splashFullScreen": true,
                "splashImmersive": true
              }
            }
          }
          EOF

      # 2. Add Android Platform
      - name: Add Android Platform
        run: npx cap add android

      # 3. FORCE APP NAME TO 'AERO'
      - name: Set App Name to AERO
        run: |
          STRINGS_XML=android/app/src/main/res/values/strings.xml
          sed -i 's/<string name="app_name">.*<\/string>/<string name="app_name">AERO<\/string>/' $STRINGS_XML

      # 4. INJECT CAMERA PERMISSIONS
      - name: Inject Camera Permissions
        run: |
          MANIFEST_FILE=android/app/src/main/AndroidManifest.xml
          sed -i '/<manifest/a \    <uses-permission android:name="android.permission.CAMERA" />\n    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />' $MANIFEST_FILE

      # 5. FORCE OVERWRITE LOGO & SPLASH
      - name: Update App Icon & Splash
        run: |
          echo "Starting Icon & Splash Overwrite..."
          RES_DIR=android/app/src/main/res
          
          # Determine which file to use for Splash
          if [ -f splash.png ]; then
            echo "Custom splash.png found! Using it."
            SPLASH_SRC=splash.png
          else
            echo "No splash.png found. Falling back to logo.png."
            SPLASH_SRC=logo.png
          fi
          
          # Delete Adaptive Icons (Forces Android to use our PNGs)
          rm -rf $RES_DIR/mipmap-anydpi-v26
          
          # LOOP THROUGH DENSITIES
          for density in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            # A. Update APP ICONS (Always uses logo.png)
            cp logo.png $RES_DIR/mipmap-$density/ic_launcher.png
            cp logo.png $RES_DIR/mipmap-$density/ic_launcher_round.png
            
            # B. Update SPLASH SCREEN
            mkdir -p $RES_DIR/drawable-port-$density
            cp $SPLASH_SRC $RES_DIR/drawable-port-$density/splash.png
            
            # C. Update Landscape Splash
            mkdir -p $RES_DIR/drawable-land-$density
            cp $SPLASH_SRC $RES_DIR/drawable-land-$density/splash.png
          done
          
          # Update Default Drawable (Fallback)
          mkdir -p $RES_DIR/drawable
          cp $SPLASH_SRC $RES_DIR/drawable/splash.png

          # CREATE SPLASH THEME XML (Centers the image for Android 12+)
          cat <<EOF > $RES_DIR/drawable/splash_background.xml
          <?xml version="1.0" encoding="utf-8"?>
          <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:drawable="@android:color/white" />
              <item>
                  <bitmap android:src="@drawable/splash" android:gravity="center" />
              </item>
          </layer-list>
          EOF
          
          echo "Icons and Splash updated successfully."

      # 6. Build APK
      - name: Build APK
        run: |
          npx cap sync
          cd android
          ./gradlew assembleDebug

      # 7. RENAME FILE
      - name: Rename APK to AERO
        run: |
          cd android/app/build/outputs/apk/debug/
          mv app-debug.apk AERO.apk

      # 8. Upload Result
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AERO
          path: android/app/build/outputs/apk/debug/AERO.apk
